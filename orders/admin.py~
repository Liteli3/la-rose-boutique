from django.contrib import admin
from .models import Order, OrderItem, FinancialTransaction


# Enregistrement du modèle Order avec personnalisation
class OrderItemInline(admin.TabularInline):
    model = OrderItem
    raw_id_fields = ['product']
    extra = 0  # Ne pas afficher de lignes vides par défaut


@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = ['id', 'full_name', 'email', 'total_price', 'status', 'created_at']
    list_filter = ['status', 'created_at', 'updated_at']
    search_fields = ['full_name', 'email', 'payment_id', 'address_line_1']
    inlines = [OrderItemInline]
    readonly_fields = ['total_price', 'created_at', 'updated_at', 'payment_id']

    # Ajouter un bouton pour marquer comme "Complétée" dans la liste
    actions = ['mark_order_completed']

    def mark_order_completed(self, request, queryset):
        queryset.update(status='Completed')
        self.message_user(request, f"{queryset.count()} commandes ont été marquées comme Complétées.")

    mark_order_completed.short_description = "Marquer comme Complétée (Payée/Livrée)"


# NOUVEAU : Enregistrement du modèle FinancialTransaction
@admin.register(FinancialTransaction)
class FinancialTransactionAdmin(admin.ModelAdmin):
    list_display = ['id', 'transaction_type', 'category', 'amount', 'date', 'order', 'recorded_by']
    list_filter = ['transaction_type', 'category', 'date']
    search_fields = ['description', 'order__id', 'recorded_by__username']

    # Remplir automatiquement l'utilisateur lors de l'ajout
    def save_model(self, request, obj, form, change):
        if not obj.pk:
            obj.recorded_by = request.user
        super().save_model(request, obj, form, change)

